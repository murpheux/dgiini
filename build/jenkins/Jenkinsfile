pipeline {
    agent {
        node {
            label 'linux'
        }
    }
    stages {
        stage('Preparation') {
            steps {
                // Git repository
                git 'scarlet:/projects.git/projects/dgiini'
            }
        }
        stage('Build') {
            parallel {
                stage('Build web') {
                    agent {
                        label "linux"
                    }
                    steps {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: '*/dev']],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [[$class: 'CleanBeforeCheckout'], 
                                [$class: 'CloneOption', noTags: true, reference: '', shallow: true]],
                            submoduleCfg: [],
                            userRemoteConfigs: [[
                                credentialsId: '886c7666-4207-4fed-9574-9cb2b0f4eca6',
                                url: 'ssh://jenkins@scarlet/projects.git/projects/dgiini'
                            ]
                        ]])
                        sh '''
                            cd ${WORKSPACE}/web
                            export PATH=$PATH:/home/jenkins/.npm-global/bin # use by other script
                            yarn
                            yarn build-docker
                            ssh jenkins@scarlet "mkdir -p ~/release/release_${BUILD_NUMBER}/"
                            scp -r ${workspace}/web/dist/* jenkins@scarlet:~/release/release_${BUILD_NUMBER}/
                            scp -r ${workspace}/deploy jenkins@scarlet:~/release/release_${BUILD_NUMBER}/
                        '''
                    }
                    post {
                        always {
                            echo 'Angular build complete'
                        }
                    }
                }
                stage('Build task_api') {
                    agent {
                        label "linux"
                    }
                    steps {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: '*/dev']],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [[$class: 'CleanBeforeCheckout'], 
                                [$class: 'CloneOption', noTags: true, reference: '', shallow: true]],
                            submoduleCfg: [],
                            userRemoteConfigs: [[
                                credentialsId: '886c7666-4207-4fed-9574-9cb2b0f4eca6',
                                url: 'ssh://jenkins@scarlet/projects.git/projects/dgiini'
                            ]
                        ]])
                        sh '''
                            cd ${WORKSPACE}/ms
                            export PATH=$PATH:/home/jenkins/.npm-global/bin
                            yarn
                            yarn build-task
                            cp ${workspace}/ms/dependency.json dist/mstask/package.json
                            cp ${workspace}/ms/dependency.json dist/mstask/package.json
                            ssh jenkins@scarlet "mkdir -p ~/release/release_${BUILD_NUMBER}/"
                            scp -r ${workspace}/ms/dist/mstask jenkins@scarlet:~/release/release_${BUILD_NUMBER}/
                        '''
                    }
                    post {
                        always {
                            echo 'Task Api build complete!'
                        }
                    }
                }
                stage('Build auth_api') {
                    agent {
                        label "linux"
                    }
                    steps {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: '*/dev']],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [[$class: 'CleanBeforeCheckout'], 
                                [$class: 'CloneOption', noTags: true, reference: '', shallow: true]],
                            submoduleCfg: [],
                            userRemoteConfigs: [[
                                credentialsId: '886c7666-4207-4fed-9574-9cb2b0f4eca6',
                                url: 'ssh://jenkins@scarlet/projects.git/projects/dgiini'
                            ]
                        ]])
                        sh '''
                            cd ${WORKSPACE}/ms
                            export PATH=$PATH:/home/jenkins/.npm-global/bin
                            yarn
                            yarn build-auth
                            cp ${workspace}/ms/dependency.json dist/msauth/package.json
                            cp ${workspace}/ms/dependency.json dist/msauth/package.json
                            ssh jenkins@scarlet "mkdir -p ~/release/release_${BUILD_NUMBER}/"
                            scp -r ${workspace}/ms/dist/msauth jenkins@scarlet:~/release/release_${BUILD_NUMBER}/
                        '''
                    }
                    post {
                        always {
                            echo 'Auth Api build complete!'
                        }
                    }
                }
                stage('Build msg_api') {
                    agent {
                        label "linux"
                    }
                    steps {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: '*/dev']],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [[$class: 'CleanBeforeCheckout'], 
                                [$class: 'CloneOption', noTags: true, reference: '', shallow: true]],
                            submoduleCfg: [],
                            userRemoteConfigs: [[
                                credentialsId: '886c7666-4207-4fed-9574-9cb2b0f4eca6',
                                url: 'ssh://jenkins@scarlet/projects.git/projects/dgiini'
                            ]
                        ]])
                        sh '''
                            cd ${WORKSPACE}/ms
                            export PATH=$PATH:/home/jenkins/.npm-global/bin
                            yarn
                            yarn build-msg
                            cp ${workspace}/ms/dependency.json dist/msmsg/package.json
                            cp ${workspace}/ms/dependency.json dist/msmsg/package.json
                            ssh jenkins@scarlet "mkdir -p ~/release/release_${BUILD_NUMBER}/"
                            scp -r ${workspace}/ms/dist/msmsg jenkins@scarlet:~/release/release_${BUILD_NUMBER}/
                        '''
                    }
                    post {
                        always {
                            echo 'Msg Api build complete!'
                        }
                    }
                }
            }
        }
    }
}